label: GPMS Obligations
rules:
  - label: create_proposal
    event:
      subject:
        anyUser:
      operations:
        - create
      target:
        policyElements:
          - name: PDS
            type: OA
    response:
      actions:
        - assign:
            - what:
                function:
                  name: current_user
              where:
                  name: PI
                  type: UA
        - function:
            name: create_node1
            args:
              - PI-Info
              - OA 
              - function:
                  name: concat_strings
                  args:
                    - function:
                        name: get_node_name
                        args:
                          - function:
                              name: current_user
                    - PI
              - O
        - assign:
            - what:
                function:
                  name: chair_for
                  args: 
                    - function:
                        name: current_user              
              where:
                name: Chair
                type: UA
        - assign:
            - what:
                function:
                  name: dean_for
                  args: 
                    - function:
                        name: current_user              
              where:
                name: Dean
                type: UA
        - assign:
            - what:
                function:
                  name: bm_for
                  args: 
                    - function:
                        name: current_user              
              where:
                name: Business-Manager
                type: UA 
  - label: add_copi
    event:
      subject:
        anyUser:
      operations:
        - add-copi
      target:
        policyElements:
          - name: CoPI
            type: UA
    response:
      condition:
        - function:
            name: is_node_contained_in
            args:
              - function:
                  name: copi_to_add
              - function:
                  name: get_node
                  args:
                    - CoPI-Eligible Faculty
                    - UA    
      actions:
        - function:
            name: create_node1
            args:
              - CoPI-Info
              - OA 
              - function:
                  name: concat_strings
                  args:
                    - function:
                        name: get_node_name
                        args:
                          - function:
                              name: copi_to_add
                    - CoPI
              - O                    
        - assign:
            - what:
                function:
                  name: copi_to_add
              where:
                name: CoPI
                type: UA
        - condition!:
            - function:
                name: is_node_contained_in
                args:
                  - function:
                      name: chair_for
                      args:
                        - function:
                            name: copi_to_add 
                  - function:
                      name: get_node
                      args:
                        - Chair
                        - UA                  
          assign:
            - what:
                function:
                  name: chair_for
                  args: 
                    - function:
                        name: copi_to_add              
              where:
                name: Chair
                type: UA
        - condition!:
            - function:
                name: is_node_contained_in
                args:
                  - function:
                      name: dean_for
                      args:
                        - function:
                            name: copi_to_add 
                  - function:
                      name: get_node
                      args:
                        - Dean
                        - UA 
          assign:
            - what:
                function:
                  name: dean_for
                  args: 
                    - function:
                        name: copi_to_add              
              where:
                name: Dean
                type: UA
        - condition!:
            - function:
                name: is_node_contained_in
                args:
                  - function:
                      name: bm_for
                      args:
                        - function:
                            name: copi_to_add 
                  - function:
                      name: get_node
                      args:
                        - Business-Manager
                        - UA
          assign:
            - what:
                function:
                  name: bm_for
                  args: 
                    - function:
                        name: copi_to_add              
              where:
                name: Business-Manager
                type: UA                
  - label: submit_proposal
    event:
      subject:
      operations:
        - submit
      target:
        policyElements:
          - name: Submission-Info
            type: OA
    response:
      actions:
        - deny:
            label: deny1
            subject:
              function: 
                name: get_node_name
                args: 
                  - function:
                      name: current_user
            operations:
               - write
            target:
              complement: false
              containers:
                - name: PI-Editable-Data
                  type: OA
        - deny:
            label: deny2
            subject:
              name: CoPI
              type: UA                 
            operations:
               - write
            target:
              complement: false
              containers:
                - name: CoPI-Editable-Data
                  type: OA 
        - deny:
            label: deny3
            subject:
              function: 
                name: get_node_name
                args: 
                  - function:
                      name: current_user
            operations:
               - assign-u-from
            target:
              complement: false
              containers:
                - name: CoPI
                  type: UA 
        - deny:
            label: deny4
            subject: 
              name: CoPI
              type: UA              
            operations:
              - assign-u-to
            target:
              complement: false
              containers:
                - name: SP
                  type: UA 
        - deny:
            label: deny5
            subject:
              name: CoPI
              type: UA
            operations:
              - deassign-u-to
            target:
              complement: false
              containers:
                - name: SP
                  type: UA  
        - deny:
            label: deny6
            subject:
              name: PI
              type: UA
            operations:
              - Save
              - Delete
              - Submit
            target:
              complement: false
              containers:
                - name: PDSs
                  type: OA 
        - grant:
            subject:
              name: Chair
              type: UA
            operations:
              - write
            target:
              name: Signature-Info
              type: OA 
        - grant:
            subject:
              name: Chair
              type: UA
            operations:
              - Approve
              - Disapprove
            target:
              name: Approval Content
              type: OA 
                                                           
  - label: add_sp
    event:
      subject:
        anyUser:
      operations:
        - add-sp
      target:
        policyElements:
          - name: SP
            type: UA
    response:
      condition:
        - function:
            name: is_node_contained_in
            args:
              - function:
                  name: sp_to_add
              - function:
                  name: get_node
                  args:
                    - SP-Eligible Faculty
                    - UA  
      actions:
        - function:
            name: create_node1
            args:
              - SP-Info
              - OA 
              - function:
                  name: concat_strings
                  args:
                    - function:
                        name: get_node_name
                        args:
                          - function:
                              name: sp_to_add
                    - SP
              - O
        - assign:
            - what:
                function:
                  name: sp_to_add
              where:
                name: SP
                type: UA  
  - label: delete_copi
    event:
      subject:
      operations:
        - delete-copi
      target:
        policyElements:
          - name: CoPI
            type: UA
    response:
      actions:
        - delete:
            assignments:
              - what:
                  function:
                    name: copi_to_delete
                where:
                  name: CoPI
                  type: UA
        - function:
            name: delete_node
            args:
              - function:
                  name: concat_strings
                  args:
                    - function:
                        name: get_node_name
                        args:
                          - function:
                              name: copi_to_delete
                    - CoPI 
        - condition!:
            - function:
                name: is_node_in_list
                args:
                  - function:
                      name: chair_for
                      args:
                        - function:
                            name: copi_to_delete
                  - function:
                      name: chairs_for
                      args:
                        - function:
                            name: get_children
                            args:
                              - CoPI
                              - UA 
            - function:
                name: compare_node_names
                args:
                  - function:
                      name: get_node_name
                      args:
                        - function:
                            name: chair_for
                            args: 
                              - function:
                                  name: copi_to_delete    
                  - function:
                      name: get_node_name
                      args:
                        - function:
                            name: chair_for
                            args: 
                              - function:
                                  name: current_user        
          delete:
            assignments:
              - what:
                  function:
                    name: chair_for
                    args: 
                      - function:
                          name: copi_to_delete              
                where:
                  name: Chair
                  type: UA      
  - label: delete_sp
    event:
      subject:
        anyUser:
      operations:
        - delete-sp
      target:
        policyElements:
          - name: SP
            type: UA
    response:
      actions:
        - delete:
            assignments:
              - what:
                  function:
                    name: sp_to_delete
                where:
                  name: SP
                  type: UA
        - function:
            name: delete_node
            args:
              - function:
                  name: concat_strings
                  args:
                    - function:
                        name: get_node_name
                        args:
                          - function:
                              name: sp_to_delete
                    - SP                    

  - label: chair_approve
    event:
      subject:
        anyUser:
      operations:
        - approve
      target:
        policyElements:
          - name: Chair-Approval
            type: OA
    response:
      actions:
        - function:
            name: add_properties_to_node
            args:
              - function:
                  name: current_user
              - function:
                  name: to_props
                  args:
                    - approved=true 
        - condition:
            - function:
                name: all_children_have_properties
                args:
                  - function:
                      name: get_node
                      args:
                        - Chair
                        - UA
                  - function:
                      name: to_props
                      args:
                        - approved=true          
          delete:
            associations:
              - subject:
                  name: Chair
                  type: UA
                target:
                  name: Approval Content
                  type: OA
        - condition:
            - function:
                name: all_children_have_properties
                args:
                  - function:
                      name: get_node
                      args:
                        - Chair
                        - UA
                  - function:
                      name: to_props
                      args:
                        - approved=true     
          delete:
            associations:
              - subject:
                  name: Chair
                  type: UA
                target:
                  name: Signature-Info
                  type: OA
        - condition:
            - function:
                name: all_children_have_properties
                args:
                  - function:
                      name: get_node
                      args:
                        - Chair
                        - UA
                  - function:
                      name: to_props
                      args:
                        - approved=true 
          grant:
            subject:
              name: Business-Manager
              type: UA
            operations:
              - write
            target:
              name: Signature-Info
              type: OA 
        - condition:
            - function:
                name: all_children_have_properties
                args:
                  - function:
                      name: get_node
                      args:
                        - Chair
                        - UA
                  - function:
                      name: to_props
                      args:
                        - approved=true 
          grant:
            subject:
              name: Business-Manager
              type: UA
            operations:
              - Approve
              - Disapprove
            target:
              name: Approval Content
              type: OA                  
  - label: chair_disapprove
    event:
      subject:
        anyUser:
      operations:
        - disapprove
      target:
        policyElements:
          - name: Chair-Approval
            type: OA
    response:
      actions:
        - delete:
            associations:
              - subject:
                  name: Chair
                  type: UA
                target:
                  name: Approval Content
                  type: OA
        - delete:
            associations:
              - subject:
                  name: Chair
                  type: UA
                target:
                  name: Signature-Info
                  type: OA
        - delete:
            prohibitions:
              - deny1
              - deny2
              - deny3
              - deny4
              - deny5
              - deny6
        - function:
            name: remove_properties_from_children
            args:
              - function:
                  name: get_node
                  args:
                    - Chair
                    - UA
              - function:
                  name: to_props
                  args:
                    - approved=true          
  - label: add_approval_entity
    event:
      subject:
        anyUser:
      operations:
        - assign to
      target:
        policyElements:
          - name: Current Users
            type: UA
    response:
      actions:
        - assign:
            - what:
                function:
                  name: child_of_assign
              where:
                name: Current Users
                type: UA                    